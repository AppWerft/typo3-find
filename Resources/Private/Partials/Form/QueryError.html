{namespace s=Tx_Find_ViewHelpers}
<f:comment>
	Detect Solr errors and present a link that re-runs the query after escaping
	the parameters for fields with noescape = 1.
</f:comment>

<f:if condition="{error.solr}">
	<section class="error">
		<f:translate key="Your query could not be executed."/>

		<s:newArray name="escapedQuery" array="{arguments.q}">
			<f:for each="{settings.queryFields}" as="queryField">
				<f:if condition="{queryField.noescape}">
					<f:if condition="{s:valueForKey(array:arguments.q, key:queryField.id)}">
						<s:newArray
							name="escapedQuery"
							array="{escapedQuery}"
							keys="{0:queryField.id}"
							values="{0:'{s:solrEscape(string:\"{s:valueForKey(array:arguments.q, key:queryField.id)}\")}'}"
							global="TRUE"
						/>
					</f:if>
				</f:if>
			</f:for>
			<s:newArray name="escapedArguments" array="{arguments}" keys="{0:'q'}" values="{0:escapedQuery}" global="TRUE"/>
			<f:link.action
				action="index"
				addQueryString="TRUE"
				argumentsToBeExcludedFromQueryString="{0:'tx_find_find[q]'}"
				arguments="{escapedArguments}"
				section="{settings.jumpToID}"
				noCacheHash="1"
				class="internal"
			>
				<f:translate key="Re-run the query with escaped terms."/>
			</f:link.action>
		</s:newArray>
	</section>
</f:if>
