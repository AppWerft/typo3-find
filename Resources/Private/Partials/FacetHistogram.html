{namespace s=Tx_SolrFrontend_ViewHelpers}

<div class="histogram">
	<script type="text/javascript">
		var barWidth = {f:if(condition:facetInfo.barWidth, then:facetInfo.barWidth else:1)};
		var myFacetField = '{facetInfo.field}';

		var localise = function (term) {
			return term;
		}

		var createHistogram = function (terms) {
			var jGraphDiv = jQuery('div.histogram'); // TODO: more precise selection to allow multiple histograms
			var graphWidth = jQuery('div.facets').width(); // TODO: use parent() in selection
			var canvasHeight = 150;
			jGraphDiv.css({'width': graphWidth + 'px', 'height': canvasHeight + 'px', 'position': 'relative'});

			var startSearchWithNewFacet = function (range) {
				var facetQueryString = '[' + range.from + '%20TO%20' + range.to + ']';
				console.log(facetQueryString);
				var facetLink = '<f:uri.action addQueryString="TRUE" arguments="{s:facetLinkArguments(facetName:facetName, itemName:\"%%%%\", mode:\"add\", activeFacets:activeFacets)}" argumentsToBeExcludedFromQueryString="{s:facetLinkArguments(facetName:facetName, mode:\"remove\", activeFacets:activeFacets)}"/>'.replace('%22%25%25%25%25%22', facetQueryString);
				window.location.href = document.baseURI + facetLink;
			};


			var graphData = [];
			for (var termIndex in terms) {
				var year = parseInt(terms[termIndex].name, 10);
				if (year) {
					graphData.push([year, terms[termIndex].freq]);
				}
			}

			/*	Set up xaxis with two labelled ticks, one at each end.
				Dodgy: Use whitespace to approximately position the labels in a way that they donâ€™t
				extend beyond the end of the graph (by default they are centered at the point of
				their axis, thus extending beyond the width of the graph on one site.
			*/
			var xaxisTicks = function (axis) {
				return [[axis.datamin, '      ' + axis.datamin], [axis.datamax, axis.datamax + '      ']];
			};

			// Use the colour of term list titles for the histogram.
			var graphColour = jQuery('.tx_solr_frontend .facetAdd').css('color');
			var selectionColour = jQuery('.tx_solr_frontend .facet h1').css('color');

			var graphOptions = {
				'series': {
					'bars': {
						'show': true,
						'fill': true,
						'lineWidth': 0,
						'barWidth': barWidth,
						'fillColor': graphColour
					}
				},
				'xaxis':  {
					'tickDecimals': 0,
					'ticks': xaxisTicks,
					'autoscaleMargin': null
				},
				'yaxis': {
					'position': 'right',
					'tickDecimals': 0,
					'tickFormatter': function(val, axis) {return (val != 0) ? (val) : ('');},
					'labelWidth': 30
				},
				'grid': {
					'borderWidth': 0,
				},
				'selection': {
					'mode': 'x',
					'color': selectionColour,
					'minSize': 0
				}
			};

			var plot = jQuery.plot(jGraphDiv , [{'data': graphData, 'color': graphColour}], graphOptions);

			var activeFacets = []
			<f:for each="{activeFacets}" as="activeFacet">
				activeFacets.push('{activeFacet}'.split(':'));
			</f:for>
			for (var activeFacetIndex in activeFacets) {
				var activeFacet = activeFacets[activeFacetIndex];
				if (activeFacet.length === 2 && activeFacet[0] === myFacetField) {
					var range = activeFacet[1].replace(/[\[\]]/g, '').split(' TO ');
					if (range.length === 2) {
						var selection = {}
						selection.from = parseInt(range[0]);
						selection.to = parseInt(range[1]);
						plot.setSelection({'xaxis': selection});
					}
				}
			}

			var removeTooltip = function () {
				jQuery("#solr_frontend-histogram-tooltip").remove();
			};

			var selectRanges = function (ranges) {
				var from = Math.floor(ranges.xaxis.from);
				ranges.xaxis.from = from - (from % barWidth);
				var to = Math.ceil(ranges.xaxis.to);
				ranges.xaxis.to = to - (to % barWidth);
				plot.setSelection(ranges, true);
				removeTooltip();
				startSearchWithNewFacet(ranges.xaxis);
			};

			jGraphDiv.bind('plotclick', function (event, pos, item) {
				return true;
			});

			jGraphDiv.bind('plotunselected', function() {
				return false;
			});

			jGraphDiv.bind('plotselected', function(event, ranges) {
				selectRanges(ranges);
			});

			jGraphDiv.bind('plothover', function(event, ranges, item) {
				var showTooltip = function(x, y, contents) {
					var tooltipDiv = document.createElement('div');
					tooltipDiv.setAttribute('id', 'solr_frontend-histogram-tooltip');
					tooltipDiv.appendChild(document.createTextNode(contents));
					jQuery(tooltipDiv).css( {
						'position': 'absolute',
						'display': 'none',
						'top': y - 20,
						'left': x + 5,
						'background': '#fff'
					}).appendTo('body').fadeIn(200);
				};

				removeTooltip();
				var year = Math.floor(ranges.x);
				year = year - (year % barWidth);
				for (termIndex in terms) {
					var term = terms[termIndex].name;
					if (term === year) {
						var hitCount = terms[termIndex].freq;
						var displayString = year + ': ' + hitCount + ' ' + localise('Treffer');
						tooltipY = jGraphDiv.offset().top + canvasHeight - 20;
						showTooltip(ranges.pageX, tooltipY, displayString);
					}
				}
			});

			jGraphDiv.mouseout(removeTooltip);

		}

		var data = [];
		var facetItem;
		<f:for each="{facetData.values}" as="facetItemCount" key="facetItemName">
			facetItem = {};
			facetItem['name'] = {facetItemName};
			facetItem['freq'] = {facetItemCount};
			data.push(facetItem);
		</f:for>

		createHistogram(data);
	</script>
</div>

<f:if condition="{s:facetLinkArguments(facetName:facetName, activeFacets:activeFacets, mode:'remove')}">
	<f:link.action
		addQueryString="TRUE"
		argumentsToBeExcludedFromQueryString="{s:facetLinkArguments(facetName:facetName, activeFacets:activeFacets, mode:'remove')}"
		class="facetRemove">
		<f:translate key="remove filter"/>
	</f:link.action>
</f:if>
