{namespace s=Tx_Find_ViewHelpers}
{namespace t3jquery=Tx_T3jquery_ViewHelpers}

<f:layout name="Default"/>

<f:section name="main">
<f:debug>{_all}</f:debug>
	<f:render partial="Page/Standard" arguments="{_all}"/>
	<f:render partial="Components/DetailResultPager" arguments="{_all}"/>

	<article class="detail">
		<f:if condition="{document.koordinaten}">
			<aside>
				<h2>Karte</h2>
				<div id="c-{document.id}-map" class="map"></div>
				<t3jquery:addJQueryAndScript jsfile="EXT:find/Resources/Projects/germania-sacra/germania-sacra.js">
					var ID = {s:json(data:document.id)};
					var standorte = [];
					var koordinaten, titel, queryURL, institutionengenau;
					<f:for each="{document.koordinaten}" as="koordinaten" key="index">
						koordinaten = {s:json(data:koordinaten)};
						titel = {s:json(data:document.kloster)};
						queryURL = "<f:uri.action arguments="{q:{raw:'{!geofilt pt={koordinaten} sfield=koordinaten d=100}'}, count:1000, dataFields:'id,koordinaten,kloster,orden'}" action="json" pageType="1369315139" noCacheHash="1"/>";
						institutionengenau = {s:json(data:"{s:valueForKey(array:document.koordinaten_institutionengenau, key:index)}")};
						/**
						 * We need the '' quotes around the first array key in what follows to keep TYPO3 6.0.4 from
						 *	interpreting the object itself. TYPO3 6.1 seems to be OK.
						 */
						standorte.push({
							'koordinaten': koordinaten,
							titel: titel,
							queryURL: queryURL,
							institutionengenau: institutionengenau
						});
					</f:for>

					germaniaSacra.initialise({
						'ID': ID,
						standorte: standorte
					});
				</t3jquery:addJQueryAndScript>
				<script type="text/javascript">

				</script>
			</aside>
		</f:if>

		<h1>
			<s:highlightField field="kloster" document="{document}" results="{results}"/>
		</h1>

		<div class="main">
			<f:if condition="{document.patrozinium}">
				<section class="patrozinium">
					<h2>Patrozinium</h2>
					<p><s:highlightField field="patrozinium" document="{document}" results="{results}"/></p>
				</section>
			</f:if>

			<section class="lage">
				<h2>Lage</h2>
				<ol>
					<s:transpose name="standorte" arrays="{
									name: \"{s:highlightField(field:'ort', document:document, results:results)}\",
									nameOriginal: document.ort,
									bistum: \"{s:highlightField(field:'bistum', document:document, results:results)}\",
									bistumOriginal: document.bistum
									ist_erzbistum: document.ist_erzbistum,
									wuestung: document.wuestung,
									land: \"{s:highlightField(field:'land', document:document, results:results)}\",
									von_verbal: \"{s:highlightField(field:'standort_von_verbal', document:document, results:results)}\",
									bis_verbal: \"{s:highlightField(field:'standort_bis_verbal', document:document, results:results)}\"
						}">
						<f:for each="{standorte}" as="standort">
							<li>
								<p>
									<f:if condition="{0:standort.von_verbal, 1:standort.bis_verbal} != {0:'', 1:''}">
										<span class="zeitraum">{f:format.raw(value:standort.von_verbal)} – {f:format.raw(value:standort.bis_verbal)}</span>
									</f:if>
									<span class="ort">
										<f:link.action arguments="{q: '{default: \'ort:\"{standort.nameOriginal}\"\'}'}" noCacheHash="1" title="Alle Klöster in {standort.nameOriginal} zeigen.">{f:format.raw(value:standort.name)}</f:link.action></span>{f:if(condition:standort.wuestung, then:' <span class="wuestung">(Wüstung)</span>')},

									<span class="land">{f:format.raw(value:standort.land)},</span>

									<f:if condition="{standort.bistum}">
										<span class="bistum">
											<f:link.action arguments="{q: '{default: \'bistum:\"{standort.bistum}\"\'}'}" noCacheHash="1" title="Alle Klöster im {f:if(condition:standort.ist_erzbistum, then:'Erzbistum', else:'Bistum')} {standort.bistum} zeigen.">
												{f:if(condition:standort.ist_erzbistum, then:'Erzbistum', else:'Bistum')}
												{f:format.raw(value:standort.bistum)}
											</f:link.action>
										</span>
									</f:if>
								</p>
							</li>
						</f:for>
					</s:transpose>
				</ol>
			</section>

			<section class="orden">
				<h2>Orden</h2>
				<ol>
					<s:transpose name="ordens" arrays="{
									name: \"{s:highlightField(field:'orden', document:document, results:results)}\",
									nameOriginal: document.orden,
									von_verbal: \"{s:highlightField(field:'orden_von_verbal', document:document, results:results)}\",
									bis_verbal: \"{s:highlightField(field:'orden_bis_verbal', document:document, results:results)}\"
						}">
						<f:for each="{ordens}" as="orden">
							<li>
								<p>
									<f:if condition="{0:orden.von_verbal, 1:orden.bis_verbal} != {0:'', 1:''}">
										<span class="zeitraum">{f:format.raw(value:orden.von_verbal)} – {f:format.raw(value:orden.bis_verbal)}</span>
									</f:if>
									<span class="orden">
										<f:link.action arguments="{q:'{default: \'orden:\"{orden.nameOriginal}\"\'}'}" noCacheHash="1" title="Alle Klöster der {orden.nameOriginal} zeigen.">
											{f:format.raw(value:orden.name)}
										</f:link.action>
									</span>
								</p>
							</li>
						</f:for>
					</s:transpose>
				</ol>
			</section>

			<f:if condition="{document.band_nummer}">
				<section class="germania-sacra">
					<h2>Germania-Sacra-Band</h2>
					<p>
						<f:if condition="{document.band_url}">
							<f:then>
								<f:link.external class="band-link" uri="{document.band_url.0}">
									<span class="band-nummer">{s:highlightField(field:'band_nummer', document:document, results:results, index:0)}</span>:
									<span class="band-titel">{s:highlightField(field:'band_titel', document:document, results:results, index:0)}</span>
								</f:link.external>
							</f:then>
							<f:else>
								<span class="band-nummer">{s:highlightField(field:'band_nummer', document:document, results:results, index:0)}</span>:
								<span class="band-titel">{s:highlightField(field:'band_titel', document:document, results:results, index:0)}</span>
							</f:else>
						</f:if>
						<f:if condition="{document.band_seite.0}">
							<span class="seite">S. {document.band_seite.0}</span>
						</f:if>
					</p>
				</section>
			</f:if>

			<f:if condition="{document.bemerkung_kloster.0}">
				<section class="bemerkung">
					<h2>Bemerkung</h2>
					<p>{s:highlightField(field:'bemerkung_kloster', document:document, results:results, index:0)}</p>
				</section>
			</f:if>

			<f:if condition="{document.person_name}">
				<section class="person">
					<h2>
						<f:if condition="{f:count(subject:document.person_name)} == 1">
							<f:then>Person</f:then>
							<f:else>Personen</f:else>
						</f:if>
					</h2>

					<s:transpose name="personen" arrays="{
									name: \"{s:highlightField(field:'person_name', document:document, results:results)}\",
									nameOriginal: document.person_name,
									namensalternativen_xml: \"{s:highlightField(field:'person_namensalternativen_xml', document:document, results:results, raw:1)}\",
									bezeichnung: \"{s:highlightField(field:'person_bezeichnung', document:document, results:results)}\",
									bezeichnung_plural: \"{s:highlightField(field:'person_bezeichnung_plural', document:document, results:results)}\",
									bezeichnungOriginal: document.person_bezeichnung,
									von_verbal: \"{s:highlightField(field:'person_von_verbal', document:document, results:results)}\",
									bis_verbal: \"{s:highlightField(field:'person_bis_verbal', document:document, results:results)}\",
									anmerkung: \"{s:highlightField(field:'person_anmerkung', document:document, results:results)}\",
									gso: \"{s:highlightField(field:'person_gso', document:document, results:results)}\"
						}">

						<f:if condition="{f:count(subject:personen)} > 15">
							<nav>
								<ol>
									<f:groupedFor each="{personen}" as="personenMitAmt" groupBy="bezeichnungOriginal" groupKey="amt">
										<f:alias map="{samplePerson:'{s:arrayFirst(array:personenMitAmt)}'}">
											<li><f:link.action addQueryString="1" section="c-{document.id}-amt-{s:regexp(string:amt, match:'/\s+/', replace:'_')}" noCacheHash="1">{f:count(subject:personenMitAmt)}&nbsp;<f:if condition="{f:count(subject:personenMitAmt)} == 1"><f:then>{s:valueForKey(array:samplePerson, key:'bezeichnung')}</f:then><f:else>{s:valueForKey(array:samplePerson, key:'bezeichnung_plural')}</f:else></f:if></f:link.action></li>
										</f:alias>
									</f:groupedFor>
								</ol>
							</nav>
						</f:if>

						<f:groupedFor each="{personen}" as="personenMitAmt" groupBy="bezeichnungOriginal" groupKey="amt">
							<f:alias map="{
											samplePerson:'{s:arrayFirst(array:personenMitAmt)}',
											amtClass:'{s:regexp(string:amt, match:\"/\s+/\", replace:\"_\")}'
								}">

							<section>
								<h3 id="c-{document.id}-amt-{s:regexp(string:amt, match:'/\s+/', replace:'_')}">
									{f:count(subject:personenMitAmt)}
										<f:if condition="{f:count(subject:personenMitAmt)} == 1">
											<f:then>{s:valueForKey(array:samplePerson, key:'bezeichnung')}</f:then>
											<f:else>{s:valueForKey(array:samplePerson, key:'bezeichnung_plural')}</f:else>
										</f:if>
									</f:alias>
								</h3>
								<ol>
									<f:for each="{personenMitAmt}" as="person">
										<li>
											<f:if condition="{person.von_verbal}{person.bis_verbal}">
												<span class="zeitraum">{f:format.raw(value:person.von_verbal)}{f:if(condition:person.bis_verbal, then:'-{f:format.raw(value:person.bis_verbal)}')}</span>
											</f:if>
											<f:link.external title="{person.bezeichnungOriginal} {person.nameOriginal} in der Personendatenbank anzeigen" uri="http://personendatenbank.germania-sacra.de/index/gsn/{person.gso}">
												<f:if condition="{person.name}">
													<f:then>
														<span class="name">{f:format.raw(value:person.name)}</span>
													</f:then>
													<f:else>
														unbekannter Name
													</f:else>
												</f:if>
											</f:link.external>
											<f:if condition="{person.namensalternativen_xml}">
												{f:format.raw(value:person.namensalternativen_xml)}
											</f:if>
											<f:if condition="{person.anmerkung}">
												<span class="bemerkung">{f:format.raw(value:person.anmerkung)}</span>
											</f:if>
										</li>
									</f:for>
								</ol>
							</section>
						</f:groupedFor>
					</s:transpose>
				</section>
			</f:if>

			<f:if condition="{document.literatur}">
				<section class="literatur">
					<h2>Literatur</h2>
					<ul>
						<f:for each="{s:highlightField(field:'literatur', document:document, results:results)}" as="literatur">
							<li>
								{f:format.raw(value:literatur)}
							</li>
						</f:for>
					</ul>
				</section>
			</f:if>

			<section class="permalink">
				<h2>Zitierlink</h2>
				<p>
					<f:link.external uri="http://kloester.germania-sacra.de/gsn/{document.sql_uid}">
						http://kloester.germania-sacra.de/gsn/{document.sql_uid}
					</f:link.external>
				</p>
			</section>

			<section class="link">
				<f:if condition="{document.url}">
					<h2>Links</h2>
					<ul>
						<s:transpose name="urls" arrays="{
									url: document.url,
									art: document.url_art,
									bemerkung: \"{s:highlightField(field:'url_bemerkung', document:document, results:results)}\"
						}">
							<f:for each="{urls}" as="url">
								<f:if condition="url.art">
									<li>
										<f:link.external uri="{url.url}">
											<f:translate key="label-url_type-{url.art}" default="{url.art}"/>
											<f:if condition="{url.bemerkung}">
												– {f:format.raw(value:url.bemerkung)}
											</f:if>
										</f:link.external>
									</li>
								</f:if>
							</f:for>
						</s:transpose>
					</ul>
				</f:if>
			</section>
		</div>
	</article>
</f:section>